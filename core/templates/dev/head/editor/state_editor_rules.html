<div ng-controller="StateRules">
  <md-card class="oppia-editor-card-with-avatar">
    <div class="oppia-editor-card-body">
      <div ng-if="answerGroups.length > 0">
        <ul class="nav nav-stacked nav-pills" role="tablist" ui-sortable="ANSWER_GROUP_LIST_SORTABLE_OPTIONS" ng-model="answerGroups">
          <!-- An HTML element marked ui-sortable should contain only one element,
          and this element should have an ng-repeat defined on it. See the
          ui-sortable documentation for more details. -->
          <!-- Note that adding "track by $index" here seems to mess up the final
          index in the stop() event handler. -->
          <li ng-repeat="group in answerGroups" ng-class="{'active': activeGroupIndex === $index}" class="oppia-rule-block oppia-sortable-rule-block" style="margin-top: 0;">
            <span class="oppia-rule-sort-handle" ng-if="!$last && answerGroups.length > 2">
              <img src="/images/general/drag_dots.png" width="10">
            </span>
            <a ng-click="changeActiveGroupIndex($index)" href="#" class="oppia-rule-tab protractor-test-rule-tab" ng-class="{'oppia-rule-tab-active': activeGroupIndex === $index}">
              <div style="overflow: hidden; padding-left: 10px; white-space: nowrap; width: 520px;">
                <div style="float: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 420px;" ng-if="doesOutcomeHaveFeedback(group.outcome)">
                  <[group.outcome.feedback[0] | convertToPlainText]>
                </div>
                <span ng-if="!doesOutcomeHaveFeedback(group.outcome)">
                  <em>(No feedback)</em>
                </span>
                <span>→ </span>
                <span ng-if="!isCreatingNewState(group.outcome)" ng-click="navigateToState(group.outcome.dest)" class="oppia-nested-link">
                  <[group.outcome.dest]>
                </span>
                <span ng-if="isCreatingNewState(group.outcome)">
                  <em>(<[group.outcome.newStateName]>)</em>
                </span>
              </div>
              <img src="/third_party/static/material-design-icons-1.0.1/ic_close_black_48dp.png" class="protractor-test-delete-response oppia-delete-response-button oppia-transition-200" ng-click="deleteGroup($index)"></img>
            </a>

            <div ng-if="activeGroupIndex === $index">
              <div class="oppia-editor-card-section">
                <div class="oppia-rule-body-container">
                  <group-editor rules="group.rule_specs" outcome="group.outcome" save-group="saveActiveGroup(group.rule_specs, group.outcome)" is-editable="editabilityService.isEditable()" class="protractor-test-rule-body">
                  </group-editor>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <div>
        <ul class="nav nav-stacked nav-pills" role="tablist">
          <li ng-class="{'active': activeGroupIndex === answerGroups.length}" class="oppia-rule-block" style="border-bottom: 1px solid #ccc; margin-top: 0;">
            <a ng-click="changeActiveGroupIndex(answerGroups.length)" href="#" class="oppia-rule-tab oppia-default-rule-tab protractor-test-default-rule-tab" ng-class="{'oppia-rule-tab-active': activeGroupIndex == answerGroups.length}">
              <span style="padding-left: 10px;">
                <span ng-if="getCurrentInteractionId() === 'Continue'">
                  When the button is clicked...
                </span>
                <span ng-if="getCurrentInteractionId() !== 'Continue'">
                  The answer is anything else...
                </span>
                <span>→ </span>
                <span ng-if="!isCreatingNewState(defaultOutcome)" ng-click="navigateToState(defaultOutcome.dest)" class="oppia-nested-link">
                  <[defaultOutcome.dest]>
                </span>
                <span ng-if="isCreatingNewState(defaultOutcome)">
                  <em>(<[defaultOutcome.newStateName]>)</em>
                </span>
              </span>
            </a>

            <div ng-if="activeGroupIndex === answerGroups.length">
              <div class="oppia-editor-card-section">
                <div class="oppia-rule-body-container">
                  <group-editor rule="null" outcome="defaultOutcome" save-group="saveDefaultOutcome(defaultOutcome)" is-editable="editabilityService.isEditable()" class="protractor-test-rule-body">
                  </group-editor>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </md-card>
  <md-card style="margin: 20px 0px; padding: 0px;">
    <div ng-if="editabilityService.isEditableOutsideTutorialMode() && (getCurrentInteractionId() !== 'Continue')" class="oppia-add-rule-button-container">
      <button type="button" class="btn btn-default btn-lg oppia-add-response-button protractor-test-open-add-response-modal" ng-click="openAddRuleModal()">
        + Give New Feedback
      </button>
      <button type="button" class="btn btn-default btn-lg oppia-add-response-button protractor-test-open-add-teach-oppia-modal" ng-click="openTeachOppiaModal()">
        Teach Oppia
      </button>
    </div>
  </md-card>
</div>

<script type="text/ng-template" id="modals/addRule">
  <div class="modal-header">
    <h3>Add Response</h3>
  </div>

  <div class="modal-body">
    <form name="addGroupForm.outcomeDetailsForm" class="form-inline protractor-test-add-outcome-details">
      <div class="oppia-rule-details-header" ng-if="currentInteractionId !== 'Continue'">
        <strong>If the answer provided</strong>
      </div>
      <div class="oppia-rule-details-header" ng-if="currentInteractionId === 'Continue'">
        <strong>When the button</strong>
      </div>

      <rule-editor rule="tmpRule" is-editable="editabilityService.isEditable()">
      </rule-editor>

      <br>

      <outcome-feedback-editor outcome="tmpOutcome">
      </outcome-feedback-editor>

      <br>

      <outcome-destination-editor outcome="tmpOutcome">
      </outcome-destination-editor>
    </form>
  </div>

  <div class="modal-footer">
    <button class="btn btn-default" ng-click="cancel()">Cancel</button>
    <button class="btn btn-success protractor-test-add-new-rule" ng-click="addNewResponse()" ng-disabled="addGroupForm.outcomeDetailsForm.$invalid || isSelfLoopWithNoFeedback(tmpOutcome)">Save Response</button>
  </div>
</script>

<script type="text/ng-template" id="modals/teachOppia">
  <div class="modal-header">
    <h3>Teach Oppia</h3>
  </div>

  <div class="modal-body">
    <form name="teachOppiaFor" class="form-inline">
      <div class="oppia-rule-details-header">
        <button type="button" class="btn btn-default btn-xs" ng-click="nothing()">
          <span class="glyphicon glyphicon-chevron-left" title="Previous answer">
          </span>
        </button>
        <span>
          <strong>
            Test Header
          </strong>
        </span>
        <button type="button" class="btn btn-default btn-xs" ng-click="nothing()">
          <span class="glyphicon glyphicon-chevron-right" title="Next answer">
          </span>
        </button>

        <div>
          <strong ng-if="trainingData.length == 0">
            Oppia understands all the answers submitted for this question.
          </strong>

          <br>

          <training-panel ng-if="trainingData.length > 0" answer="trainingData[0].answer" answer-feedback="trainingData[0].feedback" classification="classification" all-feedback="allFeedback" select-feedback="selectCurrentFeedback()">
          </training-panel>
        </div>
      <div>
    </form>

    <button class="btn btn-default" ng-click="nothing()">Test Oppia</button>
    <button class="btn btn-default" ng-click="nothing()">See What Oppia Knows</button>
  </div>

  <div class="modal-footer">
    <button class="btn btn-success" ng-click="finishTraining()">Done</button>
  </div>
</script>

<script type="text/ng-template" id="teaching/trainingPanel">
  <div class="form-inline" style="margin-bottom: 10px;">
    <div>
      <span><strong>If Oppia encounters the answer:</strong></span>
    </div>

    <div>
      <span><[answer]></span>
    </div>

    <div>
      <span><strong>it will reply with:</strong></span>
    </div>

    <div>
      <span><[answerFeedback]></span>
    </div>

    <br>

    <div>
      <span><strong>Is this right?</strong></span>
    </div>

    <br>

    <button class="btn btn-default" ng-disabled="changingFeedbackIndex" ng-click="beginChangingFeedbackIndex()">No</button>
    <button class="btn btn-default" ng-disabled="changingFeedbackIndex" ng-click="confirmFeedbackIndex(classification.feedbackIndex)">Yes</button>

    <br>

    <div ng-if="changingFeedbackIndex">
      <span><strong>Select correct feedback:</strong></span>
      <button ng-repeat="feedback in allFeedback track by $index" class="btn btn-default" ng-click="confirmFeedbackIndex($index)"><[feedback]></button>
    </div>
  </div>
</script>
